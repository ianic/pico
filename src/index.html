<html>
    <head>
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Pico</title>
        <style>
         html {
             font-size: 32px;  /* Base font */
         }
         button, input, select {
             width: 100%; 
             padding: 0.75rem; 
             font-size: 1rem;
             /* border: 1px solid #ccc;
                border-radius: 4px; */
             margin-bottom: 0.5rem;
         }
         .temp {
             color: steelblue;            
             text-align: center;
             font-size: 150px;        /* 32px, or use 1.5em, 24px, etc */
             font-weight: bold;      /* Optional: thicker text */
             padding: 20px;          /* Breathing room */
         }
         .active {
             color: tomato;
         }
        </style>
    </head>
    <body>
        <div id="value" class="temp"></div>

        <button id="button" type="button" onclick="onButton(this)"></button>
        
        <script>
         document.addEventListener('DOMContentLoaded', async () => {
             getLast();
         });

         const onButton = (button) => {
             button.disabled = true;
             fetch('http://pico.lan/toggle');
                 //.then(response => response.arrayBuffer())
                 //.then(buffer => updateCurrent(buffer));
         }

         const parseReading = (dv, idx) => {
             const unix = dv.getUint32(idx, true);  
             const temp = dv.getUint16(idx + 4, true);
             const flags = dv.getUint8(idx + 6, true);
             return {
                 time: unix * 1000,//new Date(unix * 1000),
                 temp: temp / 16,
                 relay: flags > 0,
             };
         }

         const getLast = () => {
             fetch('http://pico.lan/last')
                 .then(response => response.arrayBuffer())
                 .then(buffer => {                     
                     updateCurrent(buffer);
                     setTimeout(getLast, 5000);
                 });                                 
         }

         const updateCurrent = (buffer) => {
             const dv = new DataView(buffer);
             const reading = parseReading(dv, 0);
             
             const div = document.getElementById('value');
             const button = document.getElementById('button');
             
             div.textContent = (reading.temp).toString();
             if (reading.relay) {
                 div.classList.add('active');
                 button.textContent = "GASI";
             } else {
                 div.classList.remove('active');
                 button.textContent = "PALI";                 
             }
             button.disabled = false;
         }

         const getAll = () => {
             fetch('http://pico.lan/all')
                 .then(response => response.arrayBuffer())
                 .then(buffer => {                     
                     const dv = new DataView(buffer);  
                     let readings = [];
                     
                     for (idx = 0; idx + 7 <= dv.byteLength; idx += 7) {
                         const unix = dv.getUint32(idx, true);  
                         const temp = dv.getUint16(idx + 4, true);
                         const flags = dv.getUint8(idx + 6, true);
                         
                         const r = {
                             time: unix * 1000,//new Date(unix * 1000),
                             temp: temp / 4,
                             relay: flags > 0,
                         }
                         readings.push(r);
                         //if (idx == 0) updateCurrent(r);
                         
                         //console.log(`${r.time.toTimeString().slice(0,8)} ${r.temp}`);
                     }
                     console.log(readings);                     
                 });
         }         
        </script>
        
    </body>
</html>


